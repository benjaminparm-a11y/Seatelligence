{% extends "base.html" %}

{% block title %}Calendar ¬∑ Seatelligence{% endblock %}

{% block content %}
<div class="st-page">
  <div class="st-page-header">
    <div class="st-page-title">
      <h1>Calendar</h1>
      <p class="st-page-subtitle">Daily timeline by table</p>
    </div>

    <!-- Date navigation: same pattern as Bookings page -->
    <div class="bookings-header-main">
      <div class="booking-date-nav">
        <a href="{{ url_for('calendar', date=prev_date.isoformat()) }}"
           class="booking-date-nav-btn"
           aria-label="Previous day">
          ‚Üê
        </a>

        <span class="booking-date-label">
          {{ current_date.strftime("%A %d %B %Y") }}
        </span>

        <a href="{{ url_for('calendar', date=next_date.isoformat()) }}"
           class="booking-date-nav-btn"
           aria-label="Next day">
          ‚Üí
        </a>

        <form method="get"
              action="{{ url_for('calendar') }}"
              class="booking-date-picker-form">
          <label class="booking-date-picker">
            <span class="booking-date-picker-icon" aria-hidden="true">üìÖ</span>
            <input
              type="date"
              name="date"
              value="{{ current_date.isoformat() }}"
              class="booking-date-picker-input"
              onchange="this.form.submit()">
          </label>
        </form>
      </div>
    </div>
  </div>

  <div class="st-page-body">
    <section class="st-card st-card-main calendar-card">
      <div class="st-card-body calendar-body">
        <div class="calendar-scroll">
          <table class="calendar-grid">
            <thead>
              <tr>
                <th class="calendar-table-col">Table</th>
                {% for slot in time_slots %}
                  <th class="calendar-time-col">
                    {{ slot.strftime("%H:%M") }}
                  </th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for row in rows %}
                <tr>
                  <th class="calendar-table-cell">
                    {{ row.table.name or ("Table " ~ row.table.id) }}
                  </th>

                  {% for cell in row.cells %}
                    {% if cell.type == "booking" %}
                      <td class="calendar-booking-cell"
                          colspan="{{ cell.colspan }}"
                          data-table-id="{{ row.table.id }}"
                          data-slot-index="{{ cell.slot_index }}">
                        <div class="calendar-booking-pill"
                             draggable="true"
                             data-booking-index="{{ cell.booking_index }}"
                             data-table-id="{{ row.table.id }}"
                             data-date="{{ current_date.isoformat() }}"
                             title="{{ cell.booking.notes or cell.label }}">
                          <span class="calendar-booking-label">{{ cell.label }}</span>
                          <button
                            type="button"
                            class="calendar-edit-btn"
                            title="Edit booking"
                            aria-label="Edit booking"
                            data-booking-index="{{ cell.booking_index }}"
                            data-name="{{ cell.name | e }}"
                            data-party-size="{{ cell.party_size }}"
                            data-date="{{ current_date.isoformat() }}"
                            data-start-time="{{ cell.start_time }}"
                            data-end-time="{{ cell.end_time }}"
                            data-table-id="{{ row.table.id }}"
                            data-tables='{{ cell.booking.tables | tojson | e }}'
                            data-notes='{{ (cell.notes or "") | e }}'>
                            ‚úé
                          </button>
                        </div>
                      </td>
                    {% else %}
                      <td class="calendar-empty-cell"
                          colspan="{{ cell.colspan }}"
                          data-table-id="{{ row.table.id }}"
                          data-slot-index="{{ cell.slot_index }}"
                          data-date="{{ current_date.isoformat() }}">
                      </td>
                    {% endif %}
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </div>
</div>
{% endblock %}

{% block scripts %}
  <script src="{{ url_for('static', filename='js/calendar_drag_drop.js') }}"></script>
  
  <!-- Edit booking modal overlay (global, outside layout) -->
  <div id="editBookingOverlay" class="modal-overlay">
    <div id="editBookingModal" class="modal-card">
      <div class="modal-header">
        <h2>Edit booking</h2>
        <button type="button" class="modal-close-btn" id="closeEditBookingModal">&times;</button>
      </div>
      <form id="editBookingForm" method="POST" action="">
        <!-- Existing form fields: guest name, party size, table, date, time, notes -->
        <input type="hidden" name="booking_id" id="edit-booking-id">
        <div class="st-form-row">
          <label for="edit-name">Guest name
            <input type="text" name="name" id="edit-name" class="st-input" required>
          </label>
        </div>
        <div class="st-form-row">
          <label for="edit-party-size">Party size</label>
          <input type="number" name="party_size" id="edit-party-size" class="st-input" min="1" required>
        </div>
        <div class="st-form-row">
          <label>Tables</label>
          <div class="table-pill-group">
            {% for table in tables %}
            <label class="table-pill">
              <input type="checkbox" class="table-checkbox" name="table_ids" value="{{ table.id }}">
              <span>{{ table.name or ("Table " ~ table.id) }}</span>
            </label>
            {% endfor %}
          </div>
          <small class="form-text text-muted" style="font-size: 0.75rem; color: var(--stl-gray); margin-top: 0.25rem; display: block;">
            Select one or more tables.
          </small>
        </div>
        <div class="st-form-row">
          <label for="edit-date">Date
            <input type="date" name="date" id="edit-date" class="st-input" required min="{{ today.isoformat() }}" max="{{ max_booking_date.isoformat() }}">
          </label>
        </div>
        <div class="st-form-row st-form-row-2">
          <label for="edit-start-time">Start time
            <input type="time" name="start_time" id="edit-start-time" class="st-input" required>
          </label>
          <label for="edit-end-time">End time
            <input type="time" name="end_time" id="edit-end-time" class="st-input" required>
          </label>
        </div>
        <div class="st-form-row">
          <label for="edit-notes">Notes
            <textarea name="notes" id="edit-notes" class="st-textarea" rows="3"></textarea>
          </label>
        </div>
        <div class="st-modal-footer">
          <button type="button" class="st-button st-button-ghost" id="cancelEditBooking">Cancel</button>
          <button type="submit" class="st-button st-button-primary">Save changes</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Include edit booking JS -->
  <script src="{{ url_for('static', filename='js/booking_edit.js') }}"></script>
{% endblock %}
