<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Restaurant Booking</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    
    .container {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 30px;
      max-width: 1400px;
    }
    
    .left-column {
      min-width: 350px;
    }
    
    .right-column {
      min-width: 600px;
    }
    
    @media (max-width: 1000px) {
      .container {
        grid-template-columns: 1fr;
      }
    }
    
    #tables { margin-top: 20px; }
    .table-box {
      border: 1px solid #ccc;
      padding: 6px 10px;
      margin-bottom: 6px;
      border-radius: 4px;
      display: inline-block;
      margin-right: 6px;
    }
    pre {
      background: #f7f7f7;
      padding: 10px;
      border-radius: 6px;
    }
    .popup {
      position: absolute;
      background: #ffffff;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 8px 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      font-size: 13px;
      max-width: 280px;
      z-index: 1000;
    }
    .popup .title { font-weight: 600; margin-bottom: 4px; }
    .popup .close { position: absolute; right: 6px; top: 4px; cursor: pointer; color: #666; }
    
    #table-details {
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 12px;
      background: #f9f9f9;
      min-height: 100px;
      max-width: 400px;
    }
    #table-details h3 {
      margin-top: 0;
      margin-bottom: 8px;
      color: #333;
    }
    #table-details .no-selection {
      color: #999;
      font-style: italic;
    }
    #table-details .booking-item {
      padding: 6px;
      margin: 4px 0;
      background: #fff;
      border-left: 3px solid #4CAF50;
      border-radius: 3px;
    }
    
    .legend {
      display: flex;
      gap: 20px;
      margin: 10px 0;
      padding: 8px 12px;
      background: #f5f5f5;
      border-radius: 4px;
      font-size: 13px;
      align-items: center;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 3px;
      border: 1px solid #666;
    }
    
    .legend-color.available {
      background: #c8e6c9;
    }
    
    .legend-color.booked {
      background: #ffcdd2;
    }
    
    .legend-color.neutral {
      background: #e0e0e0;
    }
    
    .controls {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
    }
    
    .controls label {
      display: inline-block;
      margin-right: 5px;
      font-weight: 500;
    }
    
    .controls input, .controls button {
      margin-bottom: 10px;
    }
    
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    button:hover {
      background: #45a049;
    }
    
    input[type="text"], input[type="number"], input[type="date"], input[type="time"] {
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }
    
    h1 {
      margin-top: 0;
      margin-bottom: 20px;
      color: #333;
    }
    
    h2 {
      color: #444;
      margin-top: 20px;
      margin-bottom: 12px;
      font-size: 18px;
    }

    /* Small action buttons inside table */
    .btn-small {
      padding: 4px 8px;
      font-size: 12px;
      margin-right: 4px;
      background: #1976d2;
    }
    .btn-small:hover { background: #1565c0; }
    .btn-danger { background: #e53935; }
    .btn-danger:hover { background: #c62828; }

    /* Bookings summary */
    #bookings-summary {
      background: #f0f7ff;
      border: 1px solid #cfe3ff;
      color: #0b3d91;
      padding: 10px 12px;
      border-radius: 6px;
      margin: 8px 0 12px 0;
      font-size: 14px;
    }
    
    .canvas-container {
      display: flex;
      gap: 20px;
      margin-top: 10px;
    }
    
    #status-bar {
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-weight: 500;
      display: none;
      transition: all 0.3s ease;
    }
    
    #status-bar.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }
    
    #status-bar.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }
    
    #status-bar.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
      display: block;
    }
  </style>
</head>
<body>
  <h1>Restaurant Booking</h1>
  
  <div id="status-bar"></div>

  <div class="container">
    <!-- Left Column: Controls & Bookings -->
    <div class="left-column">
      <div class="controls">
        <h2 style="margin-top: 0;">Filters</h2>
        <div>
          <label for="date-input">Date:</label>
          <input id="date-input" type="date" onchange="loadBookings()" />
        </div>
        <div>
          <label for="time-filter">Time:</label>
          <input id="time-filter" type="time" placeholder="e.g. 19:00" style="width:110px;" onchange="loadBookings()" />
        </div>
        <button onclick="loadBookings()">Load bookings</button>
      </div>

      <div class="controls">
        <h2 style="margin-top: 0;">Create Booking</h2>
        <div>
          <input id="name" placeholder="Name" style="width: 100%; max-width: 250px;" />
        </div>
        <div>
          <input id="party" placeholder="Party size" type="number" style="width: 100px;" />
        </div>
        <div>
          <input id="start" placeholder="Start time (e.g. 19:00)" style="width: 150px;" />
        </div>
        <div>
          <input id="end" placeholder="End time (e.g. 21:00)" style="width: 150px;" />
        </div>
        <button id="create-booking-btn" onclick="createBooking()">Create</button>
        <span id="booking-loading" style="display: none; margin-left: 10px; color: #666; font-style: italic;">Saving...</span>
      </div>

      <h2>Bookings</h2>
      <div id="bookings-summary">Total bookings: 0 â€¢ Total seats: 0</div>
      <table id="bookings-table" style="border-collapse: collapse; width: 100%;">
        <thead>
          <tr style="background: #f0f0f0; border-bottom: 2px solid #ccc;">
            <th style="padding: 8px; text-align: left;">Guest Name</th>
            <th style="padding: 8px; text-align: left;">Party Size</th>
            <th style="padding: 8px; text-align: left;">Start Time</th>
            <th style="padding: 8px; text-align: left;">End Time</th>
            <th style="padding: 8px; text-align: left;">Table ID</th>
            <th style="padding: 8px; text-align: left;">Actions</th>
          </tr>
        </thead>
        <tbody id="bookings-body">
          <tr>
            <td colspan="6" style="padding: 12px; text-align: center; color: #999;">No bookings loaded</td>
          </tr>
        </tbody>
      </table>

      <h2>Tables</h2>
      <div id="tables"></div>
    </div>

    <!-- Right Column: Canvas & Table Details -->
    <div class="right-column">
      <h2>Floorplan</h2>
      <div style="margin: 6px 0 10px 0;">
        <button onclick="refreshLayout()">ðŸ”„ Refresh Layout</button>
        <button onclick="optimizeLayout()">ðŸ§  Optimize layout</button>
        <button onclick="reloadTables()">ðŸ“¥ Reload tables</button>
      </div>
      <div class="legend">
        <strong>Legend:</strong>
        <div class="legend-item">
          <div class="legend-color available"></div>
          <span>Available</span>
        </div>
        <div class="legend-item">
          <div class="legend-color booked"></div>
          <span>Booked</span>
        </div>
        <div class="legend-item">
          <div class="legend-color neutral"></div>
          <span>No date/time filter</span>
        </div>
      </div>
      <div class="canvas-container">
        <canvas id="floorplan" width="800" height="500" style="border:1px solid #ddd; display:block;">
          Your browser does not support the HTML canvas tag.
        </canvas>
        <div id="table-details">
          <div class="no-selection">Click on a table to view details</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Popup for table info -->
  <div id="table-popup" class="popup" style="display:none;"></div>

  <script>
  // Global state
  let currentBookings = [];
  let currentBookingsAll = [];
  let currentTables = [];
  let editingIndex = null; // absolute index used when editing a booking

    // Drawing transform (scale + offset to fit/center content in canvas)
    let drawScale = 1;
    let drawOffsetX = 0;
    let drawOffsetY = 0;

    // Status bar utility
    function showStatus(message, type = 'info') {
      const bar = document.getElementById('status-bar');
      bar.textContent = message;
      bar.className = type; // 'success', 'error', or 'info'
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        bar.style.display = 'none';
        bar.className = '';
      }, 5000);
    }

    function parseTimeToMinutes(hhmm) {
      if (!hhmm || typeof hhmm !== 'string') return null;
      const parts = hhmm.split(':');
      const h = parseInt(parts[0], 10);
      const m = parts.length > 1 ? parseInt(parts[1], 10) : 0;
      if (Number.isNaN(h) || Number.isNaN(m)) return null;
      return h * 60 + m;
    }

    function isBookingActiveAt(timeMinutes, booking) {
      if (timeMinutes == null) return true; // no filter applied
      const start = parseTimeToMinutes(booking.start_time);
      const end = parseTimeToMinutes(booking.end_time);
      if (start == null || end == null) return true;
      return timeMinutes >= start && timeMinutes < end;
    }

    async function loadTables() {
      try {
        const res = await fetch('/tables');
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          showStatus('Error loading tables: ' + (data.error || res.statusText), 'error');
          return;
        }
        const data = await res.json();
        currentTables = Array.isArray(data) ? data : [];
        const container = document.getElementById('tables');
        container.innerHTML = '';
        currentTables.forEach(t => {
          const div = document.createElement('div');
          div.className = 'table-box';
          div.textContent = `Table ${t.id} (${t.seats} seats)`;
          container.appendChild(div);
        });
        // After listing, draw the floorplan; if bookings already present, color with bookings
        if (currentBookings && currentBookings.length > 0) {
          drawTablesWithBookings(currentTables, currentBookings);
        } else {
          drawFloorplan(currentTables);
        }
      } catch (err) {
        console.error('Load tables error:', err);
        showStatus('Failed to load tables: ' + err.message, 'error');
      }
    }

    function refreshLayout() {
      // Re-fetch tables and redraw; bookings overlay will be applied if available
      loadTables();
    }

    async function reloadTables() {
      try {
        showStatus('Reloading tables...', 'info');
        await loadTables();
        showStatus('Tables reloaded successfully', 'success');
      } catch (err) {
        console.error('Reload tables error:', err);
        showStatus('Failed to reload tables: ' + err.message, 'error');
      }
    }

    async function optimizeLayout() {
      const dateInput = document.getElementById('date-input').value;
      if (!dateInput) {
        showStatus('Pick a date first', 'error');
        return;
      }
      try {
        showStatus('Optimizing layout...', 'info');
        const res = await fetch('/optimize', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ date: dateInput })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          // Prefer backend error message; include first validation error if present
          let msg = data.error || (Array.isArray(data.errors) && data.errors[0]) || 'Optimization failed';
          showStatus(msg, 'error');
          return;
        }

        // Success response; update tables in-memory
        const newTables = Array.isArray(data.tables) ? data.tables : [];
        currentTables = newTables;

        // Update list UI
        const container = document.getElementById('tables');
        container.innerHTML = '';
        currentTables.forEach(t => {
          const div = document.createElement('div');
          div.className = 'table-box';
          div.textContent = `Table ${t.id} (${t.seats} seats)`;
          container.appendChild(div);
        });

        // Redraw canvas with new layout
        if (currentBookings && currentBookings.length > 0) {
          drawTablesWithBookings(currentTables, currentBookings);
        } else {
          drawFloorplan(currentTables);
        }

        // Only show optimisation success if layout actually changed
        if (data.optimized) {
          // Reload tables from backend to keep UI fully in sync (will overwrite positions if persisted)
          await reloadTables();
          // After reload status messages, show final success per requirement
          showStatus('Layout optimised', 'success');
        } else {
          showStatus(data.message || 'No optimization needed', 'info');
        }
      } catch (err) {
        console.error('Optimize error', err);
        showStatus('Optimization request failed. Check console for details.', 'error');
      }
    }

    // Compute a drawing transform so the tables from tables.json fit inside the canvas
    function computeDrawingTransform(tables) {
      const canvas = document.getElementById('floorplan');
      if (!canvas || !Array.isArray(tables) || tables.length === 0) {
        drawScale = 1; drawOffsetX = 0; drawOffsetY = 0; return;
      }
      // Determine the content bounds in table coordinate space
      let maxX = 0, maxY = 0;
      for (const t of tables) {
        const x = (typeof t.x === 'number' ? t.x : 0) + (typeof t.width === 'number' ? t.width : 60);
        const y = (typeof t.y === 'number' ? t.y : 0) + (typeof t.height === 'number' ? t.height : 60);
        if (x > maxX) maxX = x;
        if (y > maxY) maxY = y;
      }
      const margin = 20; // keep a small margin inside the canvas
      const fitScale = Math.min(
        (canvas.width - margin) / (maxX || 1),
        (canvas.height - margin) / (maxY || 1),
        1
      );
      // Optional hint scale to keep everything comfortable inside the canvas
      const SCALE_HINT = 0.8; // tweakable if you want more/less zoom
      drawScale = Math.min(fitScale, SCALE_HINT);
      const contentW = maxX * drawScale;
      const contentH = maxY * drawScale;
      // Center the content
      drawOffsetX = Math.max(0, (canvas.width - contentW) / 2);
      drawOffsetY = Math.max(0, (canvas.height - contentH) / 2);
    }

    // Canvas interaction helpers
    function getCanvasPos(evt) {
      const canvas = document.getElementById('floorplan');
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      return {
        x: (evt.clientX - rect.left) * scaleX,
        y: (evt.clientY - rect.top) * scaleY,
        pageX: evt.pageX,
        pageY: evt.pageY,
      };
    }

    function findTableAt(x, y, tables) {
      if (!Array.isArray(tables)) return null;
      const scale = drawScale || 1;
      // Convert from canvas coordinates to table (world) coordinates
      const worldX = (x - drawOffsetX) / scale;
      const worldY = (y - drawOffsetY) / scale;
      // Iterate from last to first so later-drawn tables could take precedence
      for (let i = tables.length - 1; i >= 0; i--) {
        const t = tables[i];
        const tx = typeof t.x === 'number' ? t.x : 0;
        const ty = typeof t.y === 'number' ? t.y : 0;
        const tw = typeof t.width === 'number' ? t.width : 60;
        const th = typeof t.height === 'number' ? t.height : 60;
        if (worldX >= tx && worldX <= tx + tw && worldY >= ty && worldY <= ty + th) {
          return t;
        }
      }
      return null;
    }

    function hidePopup() {
      const p = document.getElementById('table-popup');
      p.style.display = 'none';
    }

    function showPopup(pageX, pageY, table, bookings) {
      const p = document.getElementById('table-popup');
      const items = (bookings || []).map(b => `â€¢ ${b.name} â€” ${b.party_size} ppl, ${b.start_time}-${b.end_time}`).join('<br>');
      const content = `
        <div class="title">Table ${table.id} (${table.seats} seats)</div>
        <div class="close" onclick="hidePopup()">âœ–</div>
        ${items || '<em>No bookings at selected time</em>'}
      `;
      p.innerHTML = content;
      p.style.left = (pageX + 10) + 'px';
      p.style.top = (pageY + 10) + 'px';
      p.style.display = 'block';
    }

    function showTableDetails(table, bookings) {
      const panel = document.getElementById('table-details');
      let html = `<h3>Table ${table.id}</h3>`;
      html += `<p><strong>Capacity:</strong> ${table.seats} seats</p>`;
      html += `<p><strong>Position:</strong> (${table.x}, ${table.y})</p>`;
      html += `<p><strong>Size:</strong> ${table.width} Ã— ${table.height}</p>`;
      
      const timeFilter = document.getElementById('time-filter').value;
      const timeDisplay = timeFilter ? ` at ${timeFilter}` : '';
      html += `<h4 style="margin-top: 12px; margin-bottom: 6px;">Bookings${timeDisplay}</h4>`;
      
      if (!bookings || bookings.length === 0) {
        html += `<p class="no-selection">No bookings for this table</p>`;
      } else {
        bookings.forEach(b => {
          html += `<div class="booking-item">`;
          html += `<strong>${b.name}</strong><br>`;
          html += `Party of ${b.party_size}<br>`;
          html += `${b.start_time} - ${b.end_time}`;
          html += `</div>`;
        });
      }
      
      panel.innerHTML = html;
    }

    function onCanvasClick(evt) {
      const pos = getCanvasPos(evt);
      const table = findTableAt(pos.x, pos.y, currentTables);
      if (!table) { 
        // Reset to default message if clicking outside tables
        const panel = document.getElementById('table-details');
        panel.innerHTML = '<div class="no-selection">Click on a table to view details</div>';
        return; 
      }
      const matches = (currentBookings || []).filter(b => b.table_id === table.id);
      showTableDetails(table, matches);
    }

    // Draw all tables with a neutral gray style
    function drawFloorplan(tables) {
      const canvas = document.getElementById('floorplan');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      if (!ctx) return;

      // Compute transform to fit within canvas
      computeDrawingTransform(tables);

      // Clear previous drawing
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Optional light background
      ctx.fillStyle = '#fafafa';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      tables.forEach(t => {
        const x = typeof t.x === 'number' ? t.x : 0;
        const y = typeof t.y === 'number' ? t.y : 0;
        const w = typeof t.width === 'number' ? t.width : 60;
        const h = typeof t.height === 'number' ? t.height : 60;
        const sx = drawOffsetX + x * drawScale;
        const sy = drawOffsetY + y * drawScale;
        const sw = w * drawScale;
        const sh = h * drawScale;
        // Neutral gray table
        ctx.fillStyle = '#e0e0e0';
        ctx.strokeStyle = '#666';
        // Table rectangle
        ctx.fillRect(sx, sy, sw, sh);
        ctx.lineWidth = 1;
        ctx.strokeRect(sx, sy, sw, sh);

        // Table ID text (ensure readable)
  ctx.font = '12px sans-serif';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  // Add a light outline for contrast
  ctx.lineWidth = 3;
  ctx.strokeStyle = 'rgba(255,255,255,0.85)';
  ctx.strokeText(`T${t.id}`, sx + sw / 2, sy + sh / 2);
  ctx.fillStyle = '#000';
  ctx.fillText(`T${t.id}`, sx + sw / 2, sy + sh / 2);
      });
    }

    // Draw tables colored by booking data: red if booked at the selected time, green otherwise
    function drawTablesWithBookings(tables, bookings) {
      const canvas = document.getElementById('floorplan');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      if (!ctx) return;

      // Compute transform to fit within canvas
      computeDrawingTransform(tables);

      // Build a set of booked table_ids
      const bookedSet = new Set();
      if (Array.isArray(bookings)) {
        bookings.forEach(b => {
          if (b && b.table_id !== null && b.table_id !== undefined) {
            bookedSet.add(b.table_id);
          }
        });
      }

      // Clear and background
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = '#fafafa';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Draw each table with red/green
      tables.forEach(t => {
        const x = typeof t.x === 'number' ? t.x : 0;
        const y = typeof t.y === 'number' ? t.y : 0;
        const w = typeof t.width === 'number' ? t.width : 60;
        const h = typeof t.height === 'number' ? t.height : 60;
        const sx = drawOffsetX + x * drawScale;
        const sy = drawOffsetY + y * drawScale;
        const sw = w * drawScale;
        const sh = h * drawScale;

        if (bookedSet.has(t.id)) {
          // Booked: red
          ctx.fillStyle = '#ffcdd2';
          ctx.strokeStyle = '#c62828';
        } else {
          // Free: green
          ctx.fillStyle = '#c8e6c9';
          ctx.strokeStyle = '#2e7d32';
        }
        ctx.fillRect(sx, sy, sw, sh);
        ctx.lineWidth = 1;
        ctx.strokeRect(sx, sy, sw, sh);

        // ID text with outline
        ctx.font = '12px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.lineWidth = 3;
        ctx.strokeStyle = 'rgba(255,255,255,0.85)';
        ctx.strokeText(`T${t.id}`, sx + sw / 2, sy + sh / 2);
        ctx.fillStyle = '#000';
        ctx.fillText(`T${t.id}`, sx + sw / 2, sy + sh / 2);
      });
    }

    async function loadBookings() {
      const dateInput = document.getElementById('date-input').value;
      if (!dateInput) {
        showStatus('Pick a date first', 'error');
        return;
      }
      
      try {
        const res = await fetch(`/bookings?date=${dateInput}`);
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          showStatus('Error loading bookings: ' + (data.error || res.statusText), 'error');
          return;
        }
        const data = await res.json();
  // Save all bookings for the selected date (unfiltered)
  currentBookingsAll = Array.isArray(data) ? data : [];

  // Update summary (totals for the whole date)
  updateBookingsSummary();

        // Apply time filter if provided
        const timeStr = document.getElementById('time-filter').value.trim();
        const timeMinutes = parseTimeToMinutes(timeStr);
        if (timeStr && timeMinutes == null) {
          showStatus('Invalid time format. Use HH:MM, e.g. 19:00', 'error');
          return;
        }

        currentBookings = currentBookingsAll.filter(b => isBookingActiveAt(timeMinutes, b));

        // Render bookings into the table
        const tbody = document.getElementById('bookings-body');
        tbody.innerHTML = '';
        
        if (currentBookings.length === 0) {
          const row = document.createElement('tr');
          row.innerHTML = '<td colspan="6" style="padding: 12px; text-align: center; color: #999;">No bookings found</td>';
          tbody.appendChild(row);
        } else {
          currentBookings.forEach((b, idx) => {
            const absoluteIndex = currentBookingsAll.indexOf(b); // Map filtered booking back to master list
            const row = document.createElement('tr');
            row.style.borderBottom = '1px solid #eee';
            row.setAttribute('data-booking-index', absoluteIndex);
            row.innerHTML = `
              <td style="padding: 8px;">${b.name || 'N/A'}</td>
              <td style="padding: 8px;">${b.party_size || 'N/A'}</td>
              <td style="padding: 8px;">${b.start_time || 'N/A'}</td>
              <td style="padding: 8px;">${b.end_time || 'N/A'}</td>
              <td style="padding: 8px;">${b.table_id !== null && b.table_id !== undefined ? b.table_id : 'N/A'}</td>
              <td style="padding: 8px; white-space: nowrap;">
                <button class="btn-small" onclick="editBooking(${absoluteIndex})">Edit</button>
                <button class="btn-small btn-danger" onclick="deleteBooking(${absoluteIndex})">Delete</button>
              </td>
            `;
            tbody.appendChild(row);
          });
        }

        // Color the floorplan using bookings
        drawTablesWithBookings(currentTables, currentBookings);
      } catch (err) {
        console.error('Load bookings error:', err);
        showStatus('Failed to load bookings: ' + err.message, 'error');
      }
    }

    function updateBookingsSummary() {
      try {
        const el = document.getElementById('bookings-summary');
        if (!el) return;
        const total = Array.isArray(currentBookingsAll) ? currentBookingsAll.length : 0;
        const seats = (currentBookingsAll || []).reduce((sum, b) => sum + (Number(b.party_size) || 0), 0);
        el.textContent = `Total bookings: ${total} â€¢ Total seats: ${seats}`;
      } catch (e) {
        // no-op
      }
    }

    async function createBooking() {
      const dateInput = document.getElementById('date-input').value;
      const name = document.getElementById('name').value;
      const party = document.getElementById('party').value;
      const start = document.getElementById('start').value;
      const end = document.getElementById('end').value;

      if (!dateInput || !name || !party || !start || !end) {
        showStatus('Please fill out all fields', 'error');
        return;
      }

      // Disable button and show loading state
      const btn = document.getElementById('create-booking-btn');
      const loadingMsg = document.getElementById('booking-loading');
      btn.disabled = true;
      btn.style.opacity = '0.6';
      btn.style.cursor = 'not-allowed';
      loadingMsg.style.display = 'inline';

      try {
        const res = await fetch('/bookings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            date: dateInput,
            name: name,
            party_size: Number(party),
            start_time: start,
            end_time: end
          })
        });

        const data = await res.json();
        if (!res.ok) {
          showStatus('Error: ' + (data.error || 'Unknown error'), 'error');
        } else {
          showStatus(`Booking created for ${name}, party of ${party} at table ${data.table.id}!`, 'success');
          // Clear form
          document.getElementById('name').value = '';
          document.getElementById('party').value = '';
          document.getElementById('start').value = '';
          document.getElementById('end').value = '';
          // Reload bookings to show the new one
          loadBookings();
        }
      } finally {
        // Re-enable button and hide loading state
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
        loadingMsg.style.display = 'none';
      }
    }

    // Submit update via PUT /bookings
    async function updateBooking() {
      if (editingIndex == null || editingIndex < 0 || editingIndex >= currentBookingsAll.length) {
        showStatus('No booking selected for update', 'error');
        return;
      }
      const dateInput = document.getElementById('date-input').value;
      const name = document.getElementById('name').value;
      const party = document.getElementById('party').value;
      const start = document.getElementById('start').value;
      const end = document.getElementById('end').value;
      if (!dateInput || !name || !party || !start || !end) {
        showStatus('Please fill out all fields', 'error');
        return;
      }
      const btn = document.getElementById('create-booking-btn');
      const loadingMsg = document.getElementById('booking-loading');
      btn.disabled = true;
      btn.style.opacity = '0.6';
      btn.style.cursor = 'not-allowed';
      loadingMsg.style.display = 'inline';
      try {
        const res = await fetch('/bookings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            date: dateInput,
            index: editingIndex,
            name: name,
            party_size: Number(party),
            start_time: start,
            end_time: end
          })
        });
        const data = await res.json();
        if (!res.ok) {
          showStatus('Update failed: ' + (data.error || 'Unknown error'), 'error');
          return;
        }
        showStatus('Booking updated successfully', 'success');
        // Reset form & state
        document.getElementById('name').value = '';
        document.getElementById('party').value = '';
        document.getElementById('start').value = '';
        document.getElementById('end').value = '';
        editingIndex = null;
        btn.textContent = 'Create';
        btn.onclick = createBooking;
        await loadBookings();
      } catch (err) {
        console.error('Update booking error:', err);
        showStatus('Update failed: ' + err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
        loadingMsg.style.display = 'none';
      }
    }

    // Begin editing: populate form and switch button to Update mode
    function editBooking(index) {
      if (index == null || index < 0 || index >= currentBookingsAll.length) {
        showStatus('Invalid booking index', 'error');
        return;
      }
      const b = currentBookingsAll[index];
      editingIndex = index;
      document.getElementById('name').value = b.name || '';
      document.getElementById('party').value = b.party_size || '';
      document.getElementById('start').value = b.start_time || '';
      document.getElementById('end').value = b.end_time || '';
      const btn = document.getElementById('create-booking-btn');
      btn.textContent = 'Update booking';
      btn.onclick = updateBooking;
      showStatus('Loaded booking into form. Edit and press "Update booking".', 'info');
    }

    // Delete booking via backend, then refresh UI
    async function deleteBooking(index) {
      if (index == null || index < 0 || index >= currentBookingsAll.length) {
        showStatus('Invalid booking index', 'error');
        return;
      }
      const b = currentBookingsAll[index];
      const dateInput = document.getElementById('date-input').value;
      if (!dateInput) {
        showStatus('Pick a date first', 'error');
        return;
      }
      const conf = confirm(`Delete booking "${b.name || 'N/A'}" (${b.start_time || '?'} - ${b.end_time || '?'})?`);
      if (!conf) return;
      try {
        const res = await fetch(`/bookings?date=${encodeURIComponent(dateInput)}&index=${index}` , { method: 'DELETE' });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          showStatus('Delete failed: ' + (data.error || res.statusText), 'error');
          return;
        }
        showStatus('Booking deleted', 'success');
        await loadBookings();
      } catch (err) {
        console.error('Delete booking error:', err);
        showStatus('Delete failed: ' + err.message, 'error');
      }
    }

    // Initialize on page load
    (function init() {
      // Set date input to today
      const dateInput = document.getElementById('date-input');
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      dateInput.value = `${yyyy}-${mm}-${dd}`;
      
      // Load tables immediately
      loadTables();
      
      // Load bookings for today
      loadBookings();
    })();
  </script>
  <script>
    // Attach canvas click handler after DOM loads
    (function attachCanvasHandler(){
      const canvas = document.getElementById('floorplan');
      if (!canvas) return;
      canvas.addEventListener('click', onCanvasClick);
    })();
  </script>
</body>
</html>
